<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NHS Infrastructure Map</title>
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- App styles -->
  <link rel="stylesheet" href="css/style.css" />
  <!-- Leaflet via CDN (CSS must load first) -->
  <link rel="stylesheet" href="assets/vendor/leaflet-1.9.4/leaflet.css" />
</head>
<body>
  <!-- Leaflet (local, non-blocking) -->
  <script defer src="assets/vendor/leaflet-1.9.4/leaflet.js"></script>
  <script>
    (function () {
      function injectCdn() {
        if (window.L) return; // already loaded
        var s = document.createElement('script');
        s.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
        s.defer = true;
        s.crossOrigin = 'anonymous';
        document.head.appendChild(s);
        // also ensure CSS if local CSS missing
        var css = document.createElement('link');
        css.rel = 'stylesheet';
        css.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
        document.head.appendChild(css);
      }
      addEventListener('DOMContentLoaded', function () {
        // give defer script a moment, then check
        setTimeout(injectCdn, 60);
      });
    })();
  </script>

  <div class="app-container">
    <!-- Top Bar -->
    <header class="title-bar">
      <div class="brand-area">
        <span style="font-weight:700;">Infrastructure Assets</span>
      </div>
      <div class="controls-row">
        <div class="search">
          <input type="search" id="searchAssets" placeholder="Search assets‚Ä¶" />
        </div>
        <button id="btnGrid" class="btn" title="Toggle layout">‚ò∞</button>
        <button id="btnFilter" class="btn" title="Open filters">Filter</button>
      </div>
    </header>

    <div class="main-view-wrapper">
      <div class="main-content">
        <!-- Left Nav -->
        <aside class="left-panel">
          <div class="brand">Asset Manager</div>

          <div class="nav-section">
            <h2>Navigation</h2>
            <ul class="nav-list">
              <li class="nav-item active" id="navMap">üó∫Ô∏è <span>Map View</span></li>
              <li class="nav-item" id="navList">üìã <span>List View</span></li>
              <li class="nav-item" id="navDocs">üìÑ <span>All Documents</span></li>
            </ul>
          </div>

          <div class="nav-section">
            <h2>Projects</h2>
            <ul class="nav-list">
              <li class="nav-item" id="navNewCompany">Ôºã New Company</li>
            </ul>
          </div>

          <div class="footer">
            <ul class="nav-list">
              <li class="nav-item">‚öô Settings</li>
              <li class="nav-item">üë§ Users</li>
              <li class="nav-item">‚èª Logout</li>
            </ul>
          </div>
        </aside>

        <!-- Center Map -->
        <div class="map-container" id="mapContainer">
          <div id="map" aria-label="Map"></div>
        </div>

        <!-- Right Panel -->
        <aside class="right-panel" id="rightPanel">
          <div class="station-toolbar">
            <button id="btnImportDataGlobal" class="btn">Import Data</button>
            <input id="fileImportDataGlobal" type="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display:none" />
          </div>

          <div class="chips"></div>

          <h2>Station Details</h2>
          <div id="station-details">
            <p><em>Click a pin to see details</em></p>
          </div>

          <div class="actions"></div>
        </aside>
      </div>
    </div>

    <!-- Slide-Out Filter Drawer -->
    <div id="filterDrawer" class="filter-drawer">
      <h3>Filters</h3>
      <div id="filterTree"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script>window.L_NO_TOUCH=false; window.L_DISABLE_3D=true;</script>
  <script src="js/filters.js"></script>
  <script src="js/map_view.js"></script>
  <script src="js/list_view.js"></script>
  <script src="js/station.js"></script>
  <!-- If Leaflet still missing, show banner -->
  <script>
    // gentler warn: give CDN time to load
    setTimeout(function(){
      if (!window.L) {
        var warn = document.createElement('div');
        warn.textContent = 'Leaflet failed to load from CDN.';
        warn.style.cssText = 'position:fixed;top:64px;left:0;right:0;background:#fee2e2;color:#991b1b;padding:8px 12px;z-index:99999;';
        document.body.appendChild(warn);
        console.error('[leaflet] not available; check network to unpkg.com');
      }
    }, 1500);
  </script>

  <script>
    (function(){
      const drawer = document.getElementById('filterDrawer');
      const btn = document.getElementById('btnFilter');
      if (btn && drawer) btn.addEventListener('click', () => {
        drawer.classList.toggle('open');
      });
    })();
  </script>
</body>
</html>
